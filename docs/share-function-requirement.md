# Co-fitting レシピ共有機能 要件定義書

## 1. はじめに

### 1.1. プロジェクト概要

Co-fittingは、コーヒーの味を維持したまま、出来上がり量を変化させる変換器です。ユーザーは既存のレシピを基に、希望する量に合わせてレシピを変換することができます。

### 1.2. 本機能の目的

Co-fittingで作成または変換したコーヒーレシピを、他のCo-fittingユーザーと簡単かつ確実に共有できるようにします。共有された側は、そのレシピを自身のプリセットに容易に追加できることを目指します。

## 2. 機能要件

### 2.1. 概要

ユーザーがCo-fitting上で作成・変換したレシピを、専用URLを通じて他者と共有できる機能です。共有されたユーザーは、そのレシピを自身のプリセットに簡単に追加できます。

### 2.2. ユーザーストーリー

- **レシピ共有者（送り手）として**: 自分が作成した、または調整した素晴らしいコーヒーレシピを、友人や他のCo-fittingユーザーに簡単に見せたい。URLをコピーして送るだけで、相手がそのレシピを確認し、自分のアカウントに保存できるようにしたい。
- **レシピ受信者（受け手）として**: 友人からCo-fittingのレシピURLを受け取った。URLを開くとレシピの詳細が確認でき、気に入れば自分のCo-fittingアカウントのプリセットにワンクリックで追加して、いつでもそのレシピでコーヒーを淹れられるようにしたい。

### 2.3. 詳細機能

#### 2.3.1. 共有URL生成機能

- **トリガー**: ユーザーが変換後レシピ出力欄の右下に設置された「共有ボタン」をクリックする。
- **処理**:
  - システムは、対象のレシピ情報に基づいて、共有専用の`SharedRecipe`レコードを作成し、対応する一意な共有用URL（`SharedRecipe.access_token`を利用）を生成する。
  - 生成されたURLはユーザーに提示される（例: クリップボードへの自動コピー、画面への表示）。
- **対象レシピ**: ユーザーがCo-fitting上で表示している（または変換した）レシピ。

#### 2.3.2. 共有URL経由でのレシピ受け取り・プリセット追加機能

- **アクセス**: ユーザーが共有されたURLにブラウザでアクセスする。
- **認証・認可処理**:
  - **未ログインユーザー**: ログインページへリダイレクト、またはログイン/新規登録を促すポップアップを表示する。認証成功後、共有レシピの処理を継続する。
  - **ログイン済みユーザー**: 次のステップへ進む。
- **レシピ情報の表示と追加確認**:
  - URLに対応する`SharedRecipe`の情報を基に、レシピの主要情報（レシピ名、豆量、総湯量、アイスコーヒーか否か、ステップ数など）をポップアップまたは専用ページで表示する。
  - 「このレシピをマイプリセットに追加しますか？」という確認メッセージと、「追加する」「キャンセル」の選択肢を提示する。
- **プリセットへの追加処理**:
  - ユーザーが「追加する」を選択した場合、以下のプリセット枠チェックを行う。
    - **プリセット枠に空きがある場合**: `SharedRecipe`の情報を基に、アクセスしたユーザーの新しいプリセットレシピ（`Recipe`テーブルおよび`RecipeStep`テーブル）として保存する。保存後、「レシピがマイプリセットに追加されました」という成功メッセージを表示する。
    - **プリセット枠に空きがない場合**:
      - 無料ユーザー（`preset_limit`が1で、既に1つ使用中）の場合: 「プリセット枠の上限です。枠を増やすにはサブスクリプション登録（月額100円で3枠追加）が必要です。」といったメッセージと、サブスクリプション案内ページへの導線を表示する。
      - 有料ユーザーで上限に達している場合: 「プリセット枠の上限です。既存のプリセットを編集または削除して空き容量を確保してください。」といったメッセージを表示する。
  - ユーザーが「キャンセル」を選択した場合、ポップアップを閉じる。

## 3. レシピ共有の仕組み

### 3.1. 基本方針

- 共有操作時に、元のレシピ情報を共有専用のテーブル (`SharedRecipe`, `SharedRecipeStep`) に複製します。
- 共有URLには、この複製された共有レシピデータに紐づく一意なアクセストークンを含めます。
- これにより、URLの簡潔性を保ちつつ、共有時点のレシピ内容を保証し、元レシピの変更や削除の影響を受けません。
- 共有専用テーブルのレコードは、一定期間後に削除するなどのライフサイクル管理を行い、データベースの過剰な圧迫を防ぎます。

### 3.2. データフロー

1. **共有者（送り手）**:
   1. レシピ画面で「共有ボタン」をクリック。
   2. バックエンドは、現在のレシピ情報を`SharedRecipe`テーブルおよび`SharedRecipeStep`テーブルにコピーして保存。この際、一意の`access_token`を生成・保存し、必要に応じて`expires_at`（有効期限）を設定。
   3. 生成された`access_token`を含む共有URLをフロントエンドに返す。
   4. フロントエンドは、共有URLをユーザーに提示（クリップボードコピーなど）。
2. **受信者（受け手）**:
   1. 共有URLにアクセス。
   2. バックエンドは、URL内の`access_token`を検証し、対応する`SharedRecipe`データを取得。有効期限もチェック。
   3. （未ログインの場合、ログイン/新規登録を要求）
   4. 取得したレシピ情報をフロントエンドに渡し、プレビュー表示。
   5. ユーザーが「プリセットに追加」を選択。
   6. バックエンドは、ユーザーのプリセット枠を確認。
   7. 空きがあれば、`SharedRecipe`の情報を基に、受信者の`Recipe`テーブルおよび`RecipeStep`テーブルに新しいレシピとして保存。

## 4. データモデル

### 4.1. 新規テーブル定義

以下のテーブルを新規に作成します。

```sql
-- 共有レシピ情報を格納するテーブル
CREATE TABLE SharedRecipe (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(30) NOT NULL,
    shared_by_user_id BIGINT NULL, -- 共有操作を行ったユーザーID (ログインユーザーの場合、User.idを参照)
    is_ice BOOLEAN DEFAULT FALSE,
    ice_g FLOAT NULL,
    len_steps INTEGER NOT NULL,
    bean_g FLOAT NOT NULL,
    water_ml FLOAT NOT NULL,
    memo TEXT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 共有リンク作成日時
    expires_at DATETIME NULL, -- 共有リンク有効期限 (NULLの場合は無期限、またはバッチで定期削除)
    access_token VARCHAR(255) UNIQUE NOT NULL, -- URLに含めるための一意なトークン
    FOREIGN KEY (shared_by_user_id) REFERENCES User(id) ON DELETE SET NULL
);

-- 共有レシピのステップ情報を格納するテーブル
CREATE TABLE SharedRecipeStep (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    shared_recipe_id BIGINT NOT NULL,
    step_number INTEGER NOT NULL,
    minute INTEGER NOT NULL,
    seconds INTEGER NOT NULL,
    total_water_ml_this_step FLOAT NOT NULL,
    FOREIGN KEY (shared_recipe_id) REFERENCES SharedRecipe(id) ON DELETE CASCADE
);
```

* `SharedRecipe.access_token`: URLに含めるランダムで推測困難な文字列。
* `SharedRecipe.expires_at`: 有効期限。期限切れのデータは定期的なバッチ処理で削除することを想定。

### 4.2. 既存テーブルへの影響

- `User` テーブル: 変更なし。
- `Recipe` テーブル: 変更なし。共有されたレシピを受け手がプリセットに追加する際は、このテーブルに新しいレコードが作成されます。
- `RecipeStep` テーブル: 変更なし。上記`Recipe`テーブルへの追加に伴い、このテーブルにも関連レコードが作成されます。

## 5. UI/UXデザイン案

- **共有ボタン**:
  - **配置**: 変換後レシピ出力欄の右下。
  - **デザイン**: アイコン（例: シェアアイコン）＋「共有」テキスト。
- **共有URLの通知**:
  - 共有ボタンクリック後、「共有URLがクリップボードにコピーされました！」のようなトースト通知。
  - オプションとして、URL自体も表示して手動コピー可能にする。
- **レシピ追加確認ポップアップ/ページ**:
  - **タイトル**: 例：「共有されたレシピ」
  - **表示情報**: レシピ名、豆の量、総湯量、アイスコーヒーか否か、抽出ステップ数、メモ（あれば一部表示）。
  - **アクションボタン**: 「マイプリセットに追加する」「キャンセル」
- **各種メッセージ**:
  - **成功時**: 「レシピをマイプリセットに追加しました。」
  - **エラー/案内時**:
    - ログイン要求: 「この機能を利用するにはログインが必要です。」「アカウントをお持ちでない場合は新規登録してください。」（ログイン/新規登録ページへのリンク付き）
    - プリセット枠不足（無料ユーザー）: 「プリセットの保存上限に達しました。枠を増やすにはサブスクリプションをご検討ください。」（サブスクリプション案内ページへのリンク付き）
    - プリセット枠不足（有料ユーザー）: 「プリセットの保存上限に達しました。既存のプリセットを整理してください。」
    - 無効な共有URL/期限切れ: 「この共有リンクは無効か、期限切れです。」

## 6. セキュリティ考慮事項

- **アクセストークンの機密性**: `SharedRecipe.access_token`は推測困難なランダムな文字列を生成し、安全に管理する。
- **レートリミット**: 短時間に大量の共有URLを生成する行為（DoS攻撃など）を防ぐため、APIエンドポイントに適切なレートリミットを設ける（例: IPアドレスやユーザーID単位での制限）。
- **情報漏洩リスク**: 共有されるレシピ情報に個人情報や機密情報が含まれない設計であることを再確認する（現状のレシピ項目では問題ないと想定）。
- **バッチ処理のセキュリティ**: `expires_at`を過ぎた共有レシピを削除するバッチ処理は、誤って有効なデータを削除しないよう慎重に実装・テストする。

## 7. その他（拡張性など）

- **OGP (Open Graph Protocol) 対応**: 共有されたURLがSNS（X, Facebookなど）で展開された際に、レシピ名、概要、関連画像などが適切に表示されるように、HTMLの`<meta>`タグを設定する。これにより、共有時の訴求力が高まる。
- **共有後の編集**: 受け取ったユーザーがプリセットに追加したレシピは、そのユーザー自身のレシピとして独立して扱われ、自由に編集・削除が可能。元の共有レシピや共有者のレシピには影響しない。
- **共有レシピの管理**: 将来的には、共有者が自身が共有したリンク（有効なもの）の一覧を確認したり、個別に無効化したりする機能も検討可能。

## 8. 検討した他の共有形式 (参考)

本要件定義では採用を見送りましたが、検討過程で以下の案もありました。

- **案1: レシピ情報を全てクエリパラメータに含める**
  - 概要: レシピの全情報をURLのクエリパラメータとしてエンコードして渡す。
  - 主な課題: URLが長大化し、見た目や取り扱いに問題が生じる可能性。URL最大長制限のリスク。
- **案2: (既存の)レシピIDをクエリパラメータに含める**
  - 概要: 既存の`Recipe`テーブルの`id`を直接URLに含めて共有する。
  - 主な課題: 元レシピの変更や削除によって共有リンクの内容が変わったり、リンク切れになったりする。共有時の内容が保証されない。
