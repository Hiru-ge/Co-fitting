{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/mypage.css' %}">
{% endblock %}

{% block content %}
    <div class="container">
        <h2>マイページ</h2>
        <h3>ユーザー情報</h3>
        <p>ユーザー名: {{ user.username }}</p>
        <p>メールアドレス: {{ user.email }}</p>
        <p>所有プリセット枠: <b>{{user.preset_limit}}</b><p>
        <p>サブスクリプション契約状況: <b>{{subscription_status}}</b></p>
        <div class="button-parent">
            <button class="long-button" id="email-change-btn">メールアドレス変更</button>
        </div>
        <div class="button-parent">
            <button class="long-button" id="password-change-btn">パスワード変更</button>
        </div>
        
        <h3>プリセット枠契約</h3>
        <p>月額100円でプリセット枠を3枠増やせます</p>
        <div class="button-parent">
            <button class="long-button" onclick="location.href='./purchase/create_checkout_session'">サブスク新規契約</button>
        </div>
        <div class="button-parent">
            <button class="long-button" id="subscription-status-btn" data-subscription-status="{{ subscription_status }}">契約状況確認・解約</button>
        </div>
        <h3>マイプリセット</h3>
        <p><a href="{% url 'articles:mypreset-describe' %}">マイプリセット機能とは</a></p>
        <div>
            {% if recipes %}
                {% for recipe in recipes %}
                <div class="item">
                    <div class="recipe-info">
                        <span class="recipe-name">{{ recipe.name }}</span>
                    </div>
                    <div class="button-parent">
                        <button class="edit-preset-btn" data-recipe-id="{{ recipe.id }}">編集</button>
                        <button class="delete-preset-btn" data-recipe-id="{{ recipe.id }}" data-recipe-name="{{ recipe.name }}">削除</button>
                        <button class="share-preset-btn" data-recipe-id="{{ recipe.id }}" data-recipe-name="{{ recipe.name }}">
                            <img src="{% static 'images/share-icon.png' %}" alt="共有" />
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        <div class="button-parent">
            <button class="long-button"  onclick="location.href='./preset_create/'">プリセット新規登録</button>
        </div>

        <h3 id="shared-recipes">現在共有しているレシピ一覧</h3>
        <div id="shared-recipes-list">
            <!-- 共有レシピ一覧はJavaScriptで動的に読み込まれます -->
        </div>
        
        <div class="button-parent">
            <button class="long-button" id="account-delete-btn">退会</button>
        </div>
    </div>

    <!-- メールアドレス変更モーダル -->
    <div id="email-change-modal" class="modal modal-hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <h3>メールアドレス変更</h3>
                </div>
                <span class="close" id="close-email-change-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="email-change-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="new-email">新しいメールアドレス:</label>
                        <input type="email" id="new-email" name="email" required>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">確認メール送信</button>
                        <button type="button" class="btn btn-secondary" id="cancel-email-change">キャンセル</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- パスワード変更モーダル -->
    <div id="password-change-modal" class="modal" class="modal modal-hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <h3>パスワード変更</h3>
                </div>
                <span class="close" id="close-password-change-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="password-change-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="old-password">現在のパスワード:</label>
                        <input type="password" id="old-password" name="old_password" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password1">新しいパスワード:</label>
                        <input type="password" id="new-password1" name="new_password1" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password2">新しいパスワード（確認）:</label>
                        <input type="password" id="new-password2" name="new_password2" required>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">パスワード変更</button>
                        <button type="button" class="btn btn-secondary" id="cancel-password-change">キャンセル</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 退会確認モーダル -->
    <div id="account-delete-modal" class="modal" class="modal modal-hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <h3>退会確認</h3>
                </div>
                <span class="close" id="close-account-delete-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>本当に退会しますか？この操作は元に戻せません。</p>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" id="confirm-account-delete">退会する</button>
                    <button type="button" class="btn btn-secondary" id="cancel-account-delete">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 購入キャンセルモーダル -->
    <div id="purchase-cancel-modal" class="modal" class="modal modal-hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <h3>購入キャンセル</h3>
                </div>
                <span class="close" id="close-purchase-cancel-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>購入がキャンセルされました。</p>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" id="close-purchase-cancel-btn">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 購入成功モーダル -->
    <div id="purchase-success-modal" class="modal" class="modal modal-hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <h3>購入完了</h3>
                </div>
                <span class="close" id="close-purchase-success-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>購入が完了しました。ありがとうございます。</p>
                <p>現在あなたが所有しているプリセット枠： <b id="modal-preset-limit">{{ user.preset_limit }}</b></p>
                <p>購入いただいたプリセット枠は、マイページの新規プリセット作成時にご利用いただけます。</p>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" id="close-purchase-success-btn">閉じる</button>
                    <button type="button" class="btn btn-secondary" id="portal-session-btn">サブスクリプションポータル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- パスワードリセット送信完了モーダル -->
    <div id="password-reset-sent-modal" class="modal" class="modal modal-hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <h3>パスワードリセットメール送信完了</h3>
                </div>
                <span class="close" id="close-password-reset-sent-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>パスワードリセット用のメールを送信しました。</p>
                <p>メールに記載されたリンクから新しいパスワードを設定してください。</p>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" id="close-password-reset-sent-btn">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- パスワードリセット成功モーダル -->
    <div id="password-reset-success-modal" class="modal" class="modal modal-hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <h3>パスワードリセット完了</h3>
                </div>
                <span class="close" id="close-password-reset-success-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>パスワードのリセットが完了しました。</p>
                <p>新しいパスワードでログインしてください。</p>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" id="close-password-reset-success-btn">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- サブスク未契約モーダル -->
    <div id="not-subscribed-modal" class="modal" class="modal modal-hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <h3>サブスクリプション未契約</h3>
                </div>
                <span class="close" id="close-not-subscribed-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>あなたは現在サブスクリプションを契約していません。</p>
                <p>月額100円でプリセット枠を3枠増やせます。</p>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" id="subscribe-from-modal-btn">サブスク新規契約</button>
                    <button type="button" class="btn btn-secondary" id="close-not-subscribed-btn">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div id="delete-confirm-modal" class="modal" class="modal modal-hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <h3>削除確認</h3>
                </div>
                <span class="close" id="close-delete-confirm-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p id="delete-confirm-message">本当に削除しますか？</p>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">削除</button>
                    <button type="button" class="btn btn-secondary" id="cancel-delete-btn">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'script/mypage.js' %}"></script>
{% endblock %}
